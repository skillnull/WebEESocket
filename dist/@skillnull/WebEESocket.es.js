var t=function(t){return JSON.stringify(t)},e={unknow:0,error:1,before_connect:2,connected:3,disconnected:4},n=function(){function n(t){this.EventEmitter=function(t){t||(t=new Map);var e=new Map;return{events:t,offlineEvents:e,on:function(n,i){e.size>0&&(e.forEach((function(t,e){"function"==typeof t&&t(i)})),e.clear());var s=t.get(n);s?s.push(i):t.set(n,[i])},off:function(e,n){var i=t.get(e);if(i)if(n){var s=i.indexOf(n);s>-1&&i.splice(s,1)}else t.set(e,[])},emit:function(n,i){var s=t.get(n);s?s.slice().map((function(t){t(i)})):e.set(n,[i]),(s=null==t?void 0:t.get("*"))&&s.slice().map((function(t){t(n,i)}))}}}(),this.url="",this.auth="",this.heartbeat="",this.heartbeat_time=3e3,this.state=e.unknow,this.initiative_close=!1,this.reconnect_frequency=0,this.cache_subscribe={},this.cache_subscribe_fail_list=[],this.reconnect_step=null,this.reconnect_count=0,this.url=t.url,this.auth=t.auth,this.heartbeat=null==t?void 0:t.heartbeat,this.protocol=null==t?void 0:t.auth,this.subscribe=this.subscribe.bind(this),this.unsubscribe=this.unsubscribe.bind(this),this.close=this.close.bind(this),this.on=this.on.bind(this)}return n.prototype.connect=function(){var t=this;return new Promise((function(n,i){var s;t.state=e.before_connect;var o=function(){return function(){t.websocket===s&&(t.websocket.send(t.auth),t.state=e.connected,t.reconnect_frequency=0,t.cache_subscribe_fail_list.length>0&&t.subscribeCache(),t.EventEmitter.emit("onOpen"),t.heartbeatFun())}},c=function(n){t.websocket===s&&(t.state=e.disconnected,t.initiative_close?t.initiative_close=!1:t.reconnect(),t.EventEmitter.emit("onClose",n))},r=function(n){t.websocket===s&&(t.state=e.error,t.reconnect(),t.EventEmitter.emit("onError",n))},h=function(e){if(t.websocket===s)try{var n=e.data;t.handleMessage(n),t.EventEmitter.emit("onMessage",n)}catch(t){console.log(t)}};window&&window.WebSocket?(s=new window.WebSocket(t.url),t.websocket=s,t.websocket.onopen=o,t.websocket.onclose=c,t.websocket.onerror=r,t.websocket.onmessage=h):wx&&wx.connectSocket&&(s=wx.connectSocket({url:t.url,protocols:[t.protocol],success:n,fail:i}),t.websocket=s,t.websocket.onOpen(o),t.websocket.onClose(c),t.websocket.onError(r),t.websocket.onMessage(h))}))},n.prototype.reconnect=function(t){var e=this;t?this.reconnect_step=t:null!==this.reconnect_step&&(this.reconnect_count++>=this.reconnect_step||setTimeout((function(){return e.connect()}),this.reconnect_step||1e3))},n.prototype.subscribe=function(n){var i=n.key;return this.cache_subscribe[i]=n,this.state===e.connected?this.send((null==n?void 0:n.not_stringify)?n:t(n)):(this.cache_subscribe_fail_list.push(n),this.state!==e.before_connect?this.connect():void 0)},n.prototype.subscribeCache=function(){var t,e=this;return null===(t=this.cache_subscribe_fail_list)||void 0===t?void 0:t.map((function(t){e.subscribe(t)}))},n.prototype.unsubscribe=function(e){var n=e.key;if(e.body=Object.assign({},this.cache_subscribe[n],(null==e?void 0:e.body)||{}),e.body&&"{}"!==t(e.body)){this.send((null==e?void 0:e.not_stringify)?e:t(e));var i=this.cache_subscribe_fail_list.findIndex((function(t){return t.key===n}));i>=0&&this.cache_subscribe_fail_list.splice(i,1)}},n.prototype.send=function(t){var n;this.websocket&&this.state===e.connected&&(window&&window.WebSocket?n=t:wx&&wx.connectSocket&&(n={data:t}),this.websocket.send(n))},n.prototype.handleMessage=function(t){this.EventEmitter.emit(t)},n.prototype.close=function(t,e){void 0===t&&(t=1e3),void 0===e&&(e=""),this.initiative_close=!0,this.websocket&&this.websocket.close(t,e)},n.prototype.on=function(t,e){return this.EventEmitter.on(t,e)},n.prototype.heartbeatFun=function(){var t=this;t.heartbeat&&(t.heartbeat_interval&&clearInterval(t.heartbeat_interval),t.heartbeat_interval=setInterval((function(){t.websocket.send(t.heartbeat)}),t.heartbeat_time))},n}(),i=function(t){this.socket=new n(t),-1!==(null==t?void 0:t.reconnect_step)&&this.socket.reconnect((null==t?void 0:t.reconnect_step)||1e3),this.socket.connect(),this.subscribe=this.socket.subscribe.bind(this),this.unsubscribe=this.socket.unsubscribe.bind(this),this.close=this.socket.close.bind(this),this.on=this.socket.on.bind(this)};export{i as WEBSOCKET};