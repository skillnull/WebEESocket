var e=function(e){return JSON.stringify(e)},t={unknow:0,error:1,before_connect:2,connected:3,disconnected:4},s=function(){function s(e){this.EventEmitter=function(e){e||(e=new Map);var t=new Map;return{events:e,offlineEvents:t,on:function(s,i){t.size>0&&(t.forEach((function(e,t){"function"==typeof e&&e(i)})),t.clear());var n=e.get(s);n?n.push(i):e.set(s,[i])},off:function(t,s){var i=e.get(t);if(i)if(s){var n=i.indexOf(s);n>-1&&i.splice(n,1)}else e.set(t,[])},emit:function(s,i){var n=e.get(s);n?n.slice().map((function(e){e(i)})):t.set(s,[i]),(n=null==e?void 0:e.get("*"))&&n.slice().map((function(e){e(s,i)}))}}}(),this.url="",this.auth="",this.heartbeat="",this.heartbeat_time=3e4,this.state=t.unknow,this.initiative_close=!1,this.reconnect_frequency=0,this.cache_subscribe={},this.cache_subscribe_fail_list=[],this.reconnect_step=null,this.reconnect_count=0,this.url=e.url,this.auth=e.auth,this.heartbeat=null==e?void 0:e.heartbeat,this.protocol=null==e?void 0:e.auth,this.subscribe=this.subscribe.bind(this),this.unsubscribe=this.unsubscribe.bind(this),this.reSubscribe=this.reSubscribe.bind(this),this.close=this.close.bind(this),this.on=this.on.bind(this)}return s.prototype.connect=function(e){var s=this;return void 0===e&&(e=!1),new Promise((function(i,n){var c;s.state=t.before_connect;var o=function(){return function(){s.websocket===c&&(s.websocket.send(s.auth),s.state=t.connected,s.reconnect_frequency=0,s.reSubscribe(e),s.EventEmitter.emit("onOpen"),s.heartbeatFun())}},r=function(e){s.websocket===c&&(s.state=t.disconnected,s.initiative_close?s.initiative_close=!1:s.reconnect(),s.EventEmitter.emit("onClose",e))},h=function(e){s.websocket===c&&(s.state=t.error,s.reconnect(),s.EventEmitter.emit("onError",e))},b=function(e){if(s.websocket===c)try{var t=e.data;s.handleMessage(t),s.EventEmitter.emit("onMessage",t)}catch(e){console.log(e)}};window&&window.WebSocket?(c=new window.WebSocket(s.url),s.websocket=c,s.websocket.onopen=o,s.websocket.onclose=r,s.websocket.onerror=h,s.websocket.onmessage=b):wx&&wx.connectSocket&&(c=wx.connectSocket({url:s.url,protocols:[s.protocol],success:i,fail:n}),s.websocket=c,s.websocket.onOpen(o),s.websocket.onClose(r),s.websocket.onError(h),s.websocket.onMessage(b))}))},s.prototype.reconnect=function(e){var t=this;e?this.reconnect_step=e:null!==this.reconnect_step&&this.reconnect_count++<this.reconnect_step&&setTimeout((function(){return t.connect()}),this.reconnect_step||1e3)},s.prototype.subscribe=function(s){var i=s.key;return this.cache_subscribe[i]=s,this.state===t.connected?this.send((null==s?void 0:s.not_stringify)?s:e(s)):(this.cache_subscribe_fail_list[i]=s,this.state!==t.before_connect?this.connect():void 0)},s.prototype.reSubscribe=function(e){if(void 0===e&&(e=!1),e){if(Object.keys(this.cache_subscribe).length>0)for(var t in this.cache_subscribe){(s=this.cache_subscribe[t])&&this.subscribe(s)}}else if(Object.keys(this.cache_subscribe_fail_list).length>0)for(var t in this.cache_subscribe_fail_list){var s;(s=this.cache_subscribe_fail_list[t])&&this.subscribe(s)}},s.prototype.unsubscribe=function(t){var s=t.key;t.body=Object.assign({},this.cache_subscribe[s],(null==t?void 0:t.body)||{}),t.body&&"{}"!==e(t.body)&&(this.send((null==t?void 0:t.not_stringify)?t:e(t)),delete this.cache_subscribe[s],delete this.cache_subscribe_fail_list[s])},s.prototype.send=function(e){if(this.websocket&&this.state===t.connected){var s=void 0;window&&window.WebSocket?s=e:wx&&wx.connectSocket&&(s={data:e}),this.websocket.send(s)}},s.prototype.handleMessage=function(e){this.EventEmitter.emit(e)},s.prototype.close=function(e,t){void 0===e&&(e=1e3),void 0===t&&(t=""),this.initiative_close=!0,this.websocket&&this.websocket.close(e,t)},s.prototype.on=function(e,t){return this.EventEmitter.on(e,t)},s.prototype.heartbeatFun=function(){var e=this;e.state===t.connected&&e.heartbeat&&(e.heartbeat_interval&&clearInterval(e.heartbeat_interval),e.heartbeat_interval=setInterval((function(){e.websocket.send(e.heartbeat)}),e.heartbeat_time))},s}(),i=function(e){this.socket=new s(e),-1!==(null==e?void 0:e.reconnect_step)&&this.socket.reconnect((null==e?void 0:e.reconnect_step)||1e3),this.socket.connect(),this.subscribe=this.socket.subscribe.bind(this),this.unsubscribe=this.socket.unsubscribe.bind(this),this.close=this.socket.close.bind(this),this.on=this.socket.on.bind(this)};export{i as WEBSOCKET};