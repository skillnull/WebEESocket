var e=function(e){return JSON.stringify(e)},t={unknow:0,error:1,before_connect:2,connected:3,disconnected:4},i=function(){function i(e){this.EventEmitter=function(e){e||(e=new Map);var t=new Map;return{events:e,offlineEvents:t,on:function(i,s){t.size>0&&(t.forEach((function(e,t){"function"==typeof e&&e(s)})),t.clear());var n=e.get(i);n?n.push(s):e.set(i,[s])},off:function(t,i){var s=e.get(t);if(s)if(i){var n=s.indexOf(i);n>-1&&s.splice(n,1)}else e.set(t,[])},emit:function(i,s){var n=e.get(i);n?n.slice().map((function(e){e(s)})):t.set(i,[s]),(n=null==e?void 0:e.get("*"))&&n.slice().map((function(e){e(i,s)}))}}}(),this.url="",this.auth="",this.heartbeat="",this.heartbeat_time=3e4,this.state=t.unknow,this.initiative_close=!1,this.reconnect_frequency=0,this.cache_subscribe={},this.cache_subscribe_fail_list=[],this.reconnect_step=null,this.reconnect_count=0,this.url=e.url,this.auth=e.auth,this.heartbeat=null==e?void 0:e.heartbeat,this.protocol=null==e?void 0:e.auth,this.subscribe=this.subscribe.bind(this),this.unsubscribe=this.unsubscribe.bind(this),this.reSubscribe=this.reSubscribe.bind(this),this.close=this.close.bind(this),this.on=this.on.bind(this)}return i.prototype.connect=function(e){var i=this;return void 0===e&&(e=!1),new Promise((function(s,n){var c;i.state=t.before_connect;var o=function(){return function(){i.websocket===c&&(i.websocket.send(i.auth),i.state=t.connected,i.reconnect_frequency=0,i.reSubscribe(e),i.EventEmitter.emit("onOpen"),i.heartbeatFun())}},r=function(e){i.websocket===c&&(i.state=t.disconnected,i.initiative_close?i.initiative_close=!1:i.reconnect(),i.EventEmitter.emit("onClose",e))},h=function(e){i.websocket===c&&(i.state=t.error,i.reconnect(),i.EventEmitter.emit("onError",e))},b=function(e){if(i.websocket===c)try{var t=e.data;i.handleMessage(t),i.EventEmitter.emit("onMessage",t)}catch(e){console.log(e)}};window&&window.WebSocket?(c=new window.WebSocket(i.url),i.websocket=c,i.websocket.onopen=o,i.websocket.onclose=r,i.websocket.onerror=h,i.websocket.onmessage=b):wx&&wx.connectSocket&&(c=wx.connectSocket({url:i.url,protocols:[i.protocol],success:s,fail:n}),i.websocket=c,i.websocket.onOpen(o),i.websocket.onClose(r),i.websocket.onError(h),i.websocket.onMessage(b))}))},i.prototype.reconnect=function(e){var t=this;e?this.reconnect_step=e:null!==this.reconnect_step&&this.reconnect_count++<this.reconnect_step&&setTimeout((function(){return t.connect()}),this.reconnect_step||1e3)},i.prototype.subscribe=function(i){var s=i.key;return this.cache_subscribe[s]=i,this.state===t.connected?this.send((null==i?void 0:i.not_stringify)?i:e(i)):(this.cache_subscribe_fail_list.push(i),this.state!==t.before_connect?this.connect():void 0)},i.prototype.reSubscribe=function(e){if(void 0===e&&(e=!1),e){if(Object.keys(this.cache_subscribe).length>0)for(var t in this.cache_subscribe)this.subscribe(this.cache_subscribe[t])}else if(Object.keys(this.cache_subscribe_fail_list).length>0)for(var t in this.cache_subscribe_fail_list)this.subscribe(this.cache_subscribe_fail_list[t])},i.prototype.unsubscribe=function(t){var i=t.key;if(t.body=Object.assign({},this.cache_subscribe[i],(null==t?void 0:t.body)||{}),t.body&&"{}"!==e(t.body)){this.send((null==t?void 0:t.not_stringify)?t:e(t));var s=this.cache_subscribe_fail_list.findIndex((function(e){return e.key===i}));s>=0&&this.cache_subscribe_fail_list.splice(s,1)}},i.prototype.send=function(e){if(this.websocket&&this.state===t.connected){var i=void 0;window&&window.WebSocket?i=e:wx&&wx.connectSocket&&(i={data:e}),this.websocket.send(i)}},i.prototype.handleMessage=function(e){this.EventEmitter.emit(e)},i.prototype.close=function(e,t){void 0===e&&(e=1e3),void 0===t&&(t=""),this.initiative_close=!0,this.websocket&&this.websocket.close(e,t)},i.prototype.on=function(e,t){return this.EventEmitter.on(e,t)},i.prototype.heartbeatFun=function(){var e=this;e.state===t.connected&&e.heartbeat&&(e.heartbeat_interval&&clearInterval(e.heartbeat_interval),e.heartbeat_interval=setInterval((function(){e.websocket.send(e.heartbeat)}),e.heartbeat_time))},i}(),s=function(e){this.socket=new i(e),-1!==(null==e?void 0:e.reconnect_step)&&this.socket.reconnect((null==e?void 0:e.reconnect_step)||1e3),this.socket.connect(),this.subscribe=this.socket.subscribe.bind(this),this.unsubscribe=this.socket.unsubscribe.bind(this),this.close=this.socket.close.bind(this),this.on=this.socket.on.bind(this)};export{s as WEBSOCKET};