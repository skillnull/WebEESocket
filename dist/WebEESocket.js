!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebEESocket={})}(this,(function(e){"use strict";var t=function(e){return JSON.stringify(e)},i={unknow:0,error:1,before_connect:2,connected:3,disconnected:4},n=function(){function e(e){this.EventEmitter=function(e){e||(e=new Map);var t=new Map;return{events:e,offlineEvents:t,on:function(i,n){t.size>0&&(t.forEach((function(e,t){"function"==typeof e&&e(n)})),t.clear());var s=e.get(i);s?s.push(n):e.set(i,[n])},off:function(t,i){var n=e.get(t);if(n)if(i){var s=n.indexOf(i);s>-1&&n.splice(s,1)}else e.set(t,[])},emit:function(i,n){var s=e.get(i);s?s.slice().map((function(e){e(n)})):t.set(i,[n]),(s=null==e?void 0:e.get("*"))&&s.slice().map((function(e){e(i,n)}))}}}(),this.url="",this.auth="",this.heartbeat="",this.heartbeat_time=3e4,this.state=i.unknow,this.initiative_close=!1,this.reconnect_frequency=0,this.cache_subscribe={},this.cache_subscribe_fail_list=[],this.reconnect_step=null,this.reconnect_count=0,this.url=e.url,this.auth=e.auth,this.heartbeat=null==e?void 0:e.heartbeat,this.protocol=null==e?void 0:e.auth,this.subscribe=this.subscribe.bind(this),this.unsubscribe=this.unsubscribe.bind(this),this.reSubscribe=this.reSubscribe.bind(this),this.close=this.close.bind(this),this.on=this.on.bind(this)}return e.prototype.connect=function(e){var t=this;return void 0===e&&(e=!1),new Promise((function(n,s){var c;t.state=i.before_connect;var o=function(){return function(){t.websocket===c&&(t.websocket.send(t.auth),t.state=i.connected,t.reconnect_frequency=0,t.reSubscribe(e),t.EventEmitter.emit("onOpen"),t.heartbeatFun())}},r=function(e){t.websocket===c&&(t.state=i.disconnected,t.initiative_close?t.initiative_close=!1:t.reconnect(),t.EventEmitter.emit("onClose",e))},h=function(e){t.websocket===c&&(t.state=i.error,t.reconnect(),t.EventEmitter.emit("onError",e))},b=function(e){if(t.websocket===c)try{var i=e.data;t.handleMessage(i),t.EventEmitter.emit("onMessage",i)}catch(e){console.log(e)}};window&&window.WebSocket?(c=new window.WebSocket(t.url),t.websocket=c,t.websocket.onopen=o,t.websocket.onclose=r,t.websocket.onerror=h,t.websocket.onmessage=b):wx&&wx.connectSocket&&(c=wx.connectSocket({url:t.url,protocols:[t.protocol],success:n,fail:s}),t.websocket=c,t.websocket.onOpen(o),t.websocket.onClose(r),t.websocket.onError(h),t.websocket.onMessage(b))}))},e.prototype.reconnect=function(e){var t=this;e?this.reconnect_step=e:null!==this.reconnect_step&&this.reconnect_count++<this.reconnect_step&&setTimeout((function(){return t.connect()}),this.reconnect_step||1e3)},e.prototype.subscribe=function(e){var n=e.key;return this.cache_subscribe[n]=e,this.state===i.connected?this.send((null==e?void 0:e.not_stringify)?e:t(e)):(this.cache_subscribe_fail_list.push(e),this.state!==i.before_connect?this.connect():void 0)},e.prototype.reSubscribe=function(e){if(void 0===e&&(e=!1),e){if(Object.keys(this.cache_subscribe).length>0)for(var t in this.cache_subscribe){(i=this.cache_subscribe[t])&&this.subscribe(i)}}else if(Object.keys(this.cache_subscribe_fail_list).length>0)for(var t in this.cache_subscribe_fail_list){var i;(i=this.cache_subscribe_fail_list[t])&&this.subscribe(i)}},e.prototype.unsubscribe=function(e){var i=e.key;if(e.body=Object.assign({},this.cache_subscribe[i],(null==e?void 0:e.body)||{}),e.body&&"{}"!==t(e.body)){this.send((null==e?void 0:e.not_stringify)?e:t(e));var n=this.cache_subscribe_fail_list.findIndex((function(e){return e.key===i}));n>=0&&this.cache_subscribe_fail_list.splice(n,1)}},e.prototype.send=function(e){if(this.websocket&&this.state===i.connected){var t=void 0;window&&window.WebSocket?t=e:wx&&wx.connectSocket&&(t={data:e}),this.websocket.send(t)}},e.prototype.handleMessage=function(e){this.EventEmitter.emit(e)},e.prototype.close=function(e,t){void 0===e&&(e=1e3),void 0===t&&(t=""),this.initiative_close=!0,this.websocket&&this.websocket.close(e,t)},e.prototype.on=function(e,t){return this.EventEmitter.on(e,t)},e.prototype.heartbeatFun=function(){var e=this;e.state===i.connected&&e.heartbeat&&(e.heartbeat_interval&&clearInterval(e.heartbeat_interval),e.heartbeat_interval=setInterval((function(){e.websocket.send(e.heartbeat)}),e.heartbeat_time))},e}(),s=function(e){this.socket=new n(e),-1!==(null==e?void 0:e.reconnect_step)&&this.socket.reconnect((null==e?void 0:e.reconnect_step)||1e3),this.socket.connect(),this.subscribe=this.socket.subscribe.bind(this),this.unsubscribe=this.socket.unsubscribe.bind(this),this.close=this.socket.close.bind(this),this.on=this.socket.on.bind(this)};e.WEBSOCKET=s}));